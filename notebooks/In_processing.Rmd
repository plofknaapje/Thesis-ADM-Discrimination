---
title: "In-processing measures"
output: html_notebook
---

# Imports
```{r}
library(tidymodels)
library(discrim)
library(tidyverse)
source("../scripts/metrics_on_dataset.R")
```

## Data
```{r}
df <- read_rds("../data/selection.rds") %>%
  mutate(accepted = as.factor(accepted)) %>%
  select(-rating, -gender)
```

# Modified Naive Bayes
## Functions
```{r}
# Modified Naive Bayes
df_disc <- function(df){
  fairness <- group_fairness(df, nationality, predicted)[[1]] %>%
    filter(predicted == "TRUE") %>%
    select(proportion) 
  max_val <- max(fairness)
  min_val <- min(fairness)
  max_val - min_val
}

adjust_fit <- function(model, direction){
  fit_table <- model[["fit"]][["tables"]][["nationality"]]
  CposSneg <- fit_table["TRUE", "Non_Dutch"]
  CnegSpos <- fit_table["FALSE", "Dutch"]
  if (direction == "up"){
    fit_table["TRUE", "Non_Dutch"] <- CposSneg + 0.01 * CnegSpos
    fit_table["FALSE", "Non_Dutch"] <- CposSneg - 0.01 * CnegSpos
  } else if (direction == "down"){
    fit_table["FALSE", "Dutch"] <- CnegSpos + 0.01 * CposSneg
    fit_table["TRUE", "Dutch"] <- CnegSpos - 0.01 * CposSneg
  }
  model[["fit"]][["tables"]][["nationality"]] <- fit_table
  model
}
```

```{r}
fitted_model <- naive_Bayes() %>%
  fit(accepted ~ nationality + test_score + english_cert + extracurricular, df)
df$predicted <- predict(fitted_model, df)
disc <- df_disc(df) 
print(disc)
while(disc > 0.01) {
  positive_label_count <- sum(df$accepted == "TRUE")
  predicted_positive_label_count <- sum(df$predicted == "TRUE")
  
  if (predicted_positive_label_count < positive_label_count) {
    fitted_model <- adjust_fit(fitted_model, "up")
  } else {
    fitted_model <- adjust_fit(fitted_model, "down") 
  }
  df$predicted <- predict(fitted_model, df)
  new_disc <- df_disc(df) 
  print(disc)
  if (new_disc == disc) {
    print("no improvement")
    break
  } else {
    disc <- new_disc
  }
  
}
print("Modified Naive Bayes")
print("Group fairness")
print(group_fairness(df, nationality, predicted)[[1]])
print("Causal Discrimination")
causal_disc <- causal_discrimination(df, fitted_model)
print(causal_disc[[1]])
```

# Fairness classification
